{% extends "base.html" %}

{% block content %}
<div class="search-section">
    <div class="container">
        <h1 class="search-title" data-i18n="searchTitle">PELÍCULAS</h1>
        <p class="search-subtitle" data-i18n="searchSubtitle">Buscador semántico de películas</p>

        <!-- Formulario de búsqueda principal -->
        <div class="search-form">
            <form id="searchForm">
                <div class="row g-3">
                    <div class="col-md-7">
                        <input type="text" class="form-control" id="searchTerm"
                            data-i18n-placeholder="searchPlaceholder"
                            placeholder="Buscar películas por título, director o actor..." required autocomplete="off">
                    </div>
                    <div class="col-md-3">
                        <select class="form-select" id="language">
                            <option value="es">Español</option>
                            <option value="en">English</option>
                            <option value="fr">Français</option>
                            <option value="de">Deutsch</option>
                        </select>
                    </div>
                    <div class="col-md-2">
                        <button type="submit" class="btn btn-primary w-100" data-i18n="searchButton">
                            Buscar
                        </button>
                    </div>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Sección de resultados -->
<div class="container my-4">
    <!-- Loading spinner -->
    <div id="loadingSpinner" class="text-center d-none py-4">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden" data-i18n="loading">Buscando...</span>
        </div>
        <p class="mt-2 text-muted" data-i18n="consultingDatabases">Consultando bases de datos...</p>
    </div>

    <!-- Resultados -->
    <div id="resultsSection" class="d-none">
        <!-- Pestañas -->
        <div class="row mb-3">
            <div class="col-12">
                <ul class="nav nav-pills results-tabs justify-content-center" id="resultsTabs" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="all-tab" data-bs-toggle="pill" data-bs-target="#all-pane"
                            type="button" role="tab">
                            <span data-i18n="tabAll">Todos</span> (<span id="allCount">0</span>)
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="local-tab" data-bs-toggle="pill" data-bs-target="#local-pane"
                            type="button" role="tab">
                            <span data-i18n="tabLocal">Local</span> (<span id="localCount">0</span>)
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="external-tab" data-bs-toggle="pill" data-bs-target="#external-pane"
                            type="button" role="tab">
                            <span data-i18n="tabExternal">DBpedia</span> (<span id="externalCount">0</span>)
                        </button>
                    </li>
                </ul>
            </div>
        </div>

        <!-- Contenido de las pestañas -->
        <div class="tab-content" id="resultsTabContent">
            <div class="tab-pane fade show active" id="all-pane" role="tabpanel">
                <div id="allResults" class="results-grid"></div>
            </div>
            <div class="tab-pane fade" id="local-pane" role="tabpanel">
                <div id="localResults" class="results-grid"></div>
            </div>
            <div class="tab-pane fade" id="external-pane" role="tabpanel">
                <div id="externalResults" class="results-grid"></div>
            </div>
        </div>
    </div>

    <!-- Estado sin resultados -->
    <div id="noResults" class="text-center py-5 d-none">
        <h4 class="text-muted" data-i18n="noResults">No se encontraron resultados</h4>
        <p class="text-muted" data-i18n="noResultsText">Intenta con otros términos de búsqueda.</p>
    </div>

    <!-- Estado de error -->
    <div id="errorState" class="text-center py-5 d-none">
        <h4 class="text-danger" data-i18n="searchError">Error en la búsqueda</h4>
        <p class="text-muted" id="errorMessage" data-i18n="unexpectedError">Ha ocurrido un error inesperado.</p>
    </div>
</div>

<!-- Estadísticas -->
<div class="container mb-4">
    <div class="row">
        <div class="col-12">
            <div class="stats-section">
                <div class="row text-center">
                    <div class="col-3">
                        <small class="text-muted d-block" data-i18n="localMovies">Películas Locales</small>
                        <strong id="totalMovies">-</strong>
                    </div>
                    <div class="col-3">
                        <small class="text-muted d-block" data-i18n="directors">Directores</small>
                        <strong id="totalDirectors">-</strong>
                    </div>
                    <div class="col-3">
                        <small class="text-muted d-block" data-i18n="rdfTriples">Triples RDF</small>
                        <strong id="totalTriples">-</strong>
                    </div>
                    <div class="col-3">
                        <small class="text-muted d-block">DBpedia</small>
                        <span id="dbpediaStatus">
                            <i class="fas fa-circle text-success"></i>
                        </span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    /**
     * Sistema de internacionalización (i18n)
     */
    const i18n = {
        es: {
            searchTitle: 'PELÍCULAS',
            searchSubtitle: 'Buscador semántico de películas',
            searchPlaceholder: 'Buscar películas por título, director o actor...',
            searchButton: 'Buscar',
            loading: 'Buscando...',
            consultingDatabases: 'Consultando bases de datos...',
            tabAll: 'Todos',
            tabLocal: 'Local',
            tabExternal: 'DBpedia',
            noResults: 'No se encontraron resultados',
            noResultsText: 'Intenta con otros términos de búsqueda.',
            searchError: 'Error en la búsqueda',
            unexpectedError: 'Ha ocurrido un error inesperado.',
            director: 'Director',
            year: 'Año',
            duration: 'Duración',
            genre: 'Género',
            seeMore: 'Ver más',
            noLocalResults: 'Sin resultados locales',
            noLocalResultsText: 'No se encontraron películas en tu ontología local.',
            noExternalResults: 'Sin resultados de DBpedia',
            noExternalResultsText: 'No se encontraron películas en DBpedia.',
            localMovies: 'Películas Locales',
            directors: 'Directores',
            rdfTriples: 'Triples RDF',
            enterSearchTerm: 'Por favor ingresa un término de búsqueda',
            localOntology: 'Ontología Local',
            dbpedia: 'DBpedia'
        },
        en: {
            searchTitle: 'MOVIES',
            searchSubtitle: 'Semantic movie search engine',
            searchPlaceholder: 'Search movies by title, director or actor...',
            searchButton: 'Search',
            loading: 'Searching...',
            consultingDatabases: 'Querying databases...',
            tabAll: 'All',
            tabLocal: 'Local',
            tabExternal: 'DBpedia',
            noResults: 'No results found',
            noResultsText: 'Try different search terms.',
            searchError: 'Search error',
            unexpectedError: 'An unexpected error occurred.',
            director: 'Director',
            year: 'Year',
            duration: 'Duration',
            genre: 'Genre',
            seeMore: 'See more',
            noLocalResults: 'No local results',
            noLocalResultsText: 'No movies found in your local ontology.',
            noExternalResults: 'No DBpedia results',
            noExternalResultsText: 'No movies found in DBpedia.',
            localMovies: 'Local Movies',
            directors: 'Directors',
            rdfTriples: 'RDF Triples',
            enterSearchTerm: 'Please enter a search term',
            localOntology: 'Local Ontology',
            dbpedia: 'DBpedia'
        },
        fr: {
            searchTitle: 'FILMS',
            searchSubtitle: 'Moteur de recherche sémantique de films',
            searchPlaceholder: 'Rechercher des films par titre, réalisateur ou acteur...',
            searchButton: 'Rechercher',
            loading: 'Recherche...',
            consultingDatabases: 'Consultation des bases de données...',
            tabAll: 'Tous',
            tabLocal: 'Local',
            tabExternal: 'DBpedia',
            noResults: 'Aucun résultat trouvé',
            noResultsText: 'Essayez avec d\'autres termes.',
            searchError: 'Erreur de recherche',
            unexpectedError: 'Une erreur inattendue s\'est produite.',
            director: 'Réalisateur',
            year: 'Année',
            duration: 'Durée',
            genre: 'Genre',
            seeMore: 'Voir plus',
            noLocalResults: 'Aucun résultat local',
            noLocalResultsText: 'Aucun film trouvé dans votre ontologie locale.',
            noExternalResults: 'Aucun résultat DBpedia',
            noExternalResultsText: 'Aucun film trouvé dans DBpedia.',
            localMovies: 'Films Locaux',
            directors: 'Réalisateurs',
            rdfTriples: 'Triples RDF',
            enterSearchTerm: 'Veuillez entrer un terme de recherche',
            localOntology: 'Ontologie Locale',
            dbpedia: 'DBpedia'
        },
        de: {
            searchTitle: 'FILME',
            searchSubtitle: 'Semantische Filmsuchmaschine',
            searchPlaceholder: 'Filme nach Titel, Regisseur oder Schauspieler suchen...',
            searchButton: 'Suchen',
            loading: 'Suche...',
            consultingDatabases: 'Datenbanken werden abgefragt...',
            tabAll: 'Alle',
            tabLocal: 'Lokal',
            tabExternal: 'DBpedia',
            noResults: 'Keine Ergebnisse gefunden',
            noResultsText: 'Versuchen Sie andere Suchbegriffe.',
            searchError: 'Suchfehler',
            unexpectedError: 'Ein unerwarteter Fehler ist aufgetreten.',
            director: 'Regisseur',
            year: 'Jahr',
            duration: 'Dauer',
            genre: 'Genre',
            seeMore: 'Mehr sehen',
            noLocalResults: 'Keine lokalen Ergebnisse',
            noLocalResultsText: 'Keine Filme in Ihrer lokalen Ontologie gefunden.',
            noExternalResults: 'Keine DBpedia-Ergebnisse',
            noExternalResultsText: 'Keine Filme in DBpedia gefunden.',
            localMovies: 'Lokale Filme',
            directors: 'Regisseure',
            rdfTriples: 'RDF-Tripel',
            enterSearchTerm: 'Bitte geben Sie einen Suchbegriff ein',
            localOntology: 'Lokale Ontologie',
            dbpedia: 'DBpedia'
        }
    };

    /**
     * Gestor de internacionalización
     */
    class I18nManager {
        constructor() {
            this.currentLanguage = 'es';
            this.translations = i18n;
        }

        setLanguage(lang) {
            if (this.translations[lang]) {
                this.currentLanguage = lang;
                this.updateUI();
            }
        }

        t(key) {
            return this.translations[this.currentLanguage][key] || key;
        }

        updateUI() {
            // Actualizar elementos con data-i18n
            document.querySelectorAll('[data-i18n]').forEach(el => {
                const key = el.getAttribute('data-i18n');
                const value = this.t(key);
                el.textContent = value;
            });

            // Actualizar placeholders
            document.querySelectorAll('[data-i18n-placeholder]').forEach(el => {
                const key = el.getAttribute('data-i18n-placeholder');
                const value = this.t(key);
                el.placeholder = value;
            });
        }
    }

    /**
     * Clase principal con soporte multilingüe
     */
    class CinemaSearch {
        constructor() {
            this.currentResults = {
                local: [],
                external: [],
                all: []
            };
            this.isSearching = false;
            this.i18n = new I18nManager();

            this.initializeEventListeners();
            this.loadInitialStats();
        }

        initializeEventListeners() {
            const searchForm = document.getElementById('searchForm');
            const searchInput = document.getElementById('searchTerm');
            const langSelector = document.getElementById('language');

            if (searchForm) {
                searchForm.addEventListener('submit', (e) => this.handleSearch(e));
            }

            if (langSelector) {
                langSelector.addEventListener('change', (e) => {
                    this.i18n.setLanguage(e.target.value);
                });
            }
        }

        async handleSearch(event) {
            event.preventDefault();

            const searchTerm = document.getElementById('searchTerm').value.trim();
            const language = document.getElementById('language').value;

            if (!searchTerm) {
                this.showAlert(this.i18n.t('enterSearchTerm'), 'warning');
                return;
            }

            await this.performSearch(searchTerm, language);
        }

        async performSearch(term, language) {
            if (this.isSearching) return;

            this.isSearching = true;
            this.showLoading(true);
            this.hideResults();

            try {
                const lower = term.toLowerCase();

                const isSemantic =
                    lower.includes("actuo") || lower.includes("actor") ||
                    lower.includes("actriz") || lower.includes("dirig") ||
                    lower.includes("películas de") || lower.includes("pelicula de") ||
                    lower.includes("director") || lower.includes("año") ||
                    lower.includes("estrenada") || lower.match(/(19|20)\d{2}/);

                let url = isSemantic
                    ? `/api/semantic_search?q=${encodeURIComponent(term)}&lang=${language}`
                    : `/api/search?term=${encodeURIComponent(term)}&lang=${language}`;

                const response = await fetch(url);

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const data = await response.json();

                if (data.error) {
                    throw new Error(data.error);
                }

                this.currentResults = {
                    local: data.local || [],
                    external: data.external || [],
                    all: [...(data.local || []), ...(data.external || [])]
                };

                this.displayResults();

            } catch (error) {
                console.error("Error en búsqueda:", error);
                this.showError(error.message);
            } finally {
                this.isSearching = false;
                this.showLoading(false);
            }
        }

        showLoading(show) {
            const spinner = document.getElementById('loadingSpinner');
            if (spinner) {
                spinner.classList.toggle('d-none', !show);
            }
        }

        displayResults() {
            const resultsSection = document.getElementById('resultsSection');
            const noResults = document.getElementById('noResults');

            if (this.currentResults.all.length === 0) {
                resultsSection?.classList.add('d-none');
                noResults?.classList.remove('d-none');
                return;
            }

            this.updateTabCounts();
            this.renderMovieResults('allResults', this.currentResults.all);
            this.renderMovieResults('localResults', this.currentResults.local);
            this.renderMovieResults('externalResults', this.currentResults.external);

            resultsSection?.classList.remove('d-none');
            noResults?.classList.add('d-none');
            this.hideError();
        }

        updateTabCounts() {
            const counts = {
                'allCount': this.currentResults.all.length,
                'localCount': this.currentResults.local.length,
                'externalCount': this.currentResults.external.length
            };

            Object.entries(counts).forEach(([id, count]) => {
                const el = document.getElementById(id);
                if (el) el.textContent = count;
            });
        }

        renderMovieResults(containerId, movies) {
            const container = document.getElementById(containerId);
            if (!container) return;

            if (movies.length === 0) {
                container.innerHTML = this.getEmptyStateHtml(containerId);
                return;
            }

            container.innerHTML = movies.map(m => this.createMovieCard(m)).join('');
        }

        createMovieCard(movie) {
            const sourceClass = movie.tipo === 'local' ? 'local' : 'external';
            const sourceText = movie.fuente ||
                (movie.tipo === 'local' ? this.i18n.t('localOntology') : this.i18n.t('dbpedia'));

            return `
            <div class="movie-card ${sourceClass}">
                <h3 class="movie-title">${this.escapeHtml(movie.titulo)}</h3>
                <div class="movie-director">
                    ${this.i18n.t('director')}: ${this.escapeHtml(movie.director)}
                </div>
                <p class="movie-synopsis">${this.escapeHtml(movie.sinopsis)}</p>
                
                <div class="movie-details mb-2">
                    ${movie.anio ? `
                        <div class="detail-item">
                            <small class="text-muted">${this.i18n.t('year')}: ${this.escapeHtml(movie.anio)}</small>
                        </div>
                    ` : ''}
                    
                    ${movie.duracion ? `
                        <div class="detail-item">
                            <small class="text-muted">${this.i18n.t('duration')}: ${this.escapeHtml(movie.duracion)}</small>
                        </div>
                    ` : ''}
                    
                    ${movie.genero ? `
                        <div class="detail-item">
                            <small class="text-muted">${this.i18n.t('genre')}: ${this.escapeHtml(movie.genero)}</small>
                        </div>
                    ` : ''}
                </div>
                
                <div class="movie-meta">
                    <span class="source-badge ${sourceClass}">
                        ${sourceText}
                    </span>
                    ${movie.uri ? `
                        <a href="${movie.uri}" target="_blank" class="btn btn-outline-secondary btn-sm">
                            ${this.i18n.t('seeMore')}
                        </a>
                    ` : ''}
                </div>
            </div>
        `;
        }

        getEmptyStateHtml(containerId) {
            const messages = {
                'localResults': {
                    title: this.i18n.t('noLocalResults'),
                    text: this.i18n.t('noLocalResultsText')
                },
                'externalResults': {
                    title: this.i18n.t('noExternalResults'),
                    text: this.i18n.t('noExternalResultsText')
                }
            };

            const config = messages[containerId] || {
                title: this.i18n.t('noResults'),
                text: this.i18n.t('noResultsText')
            };

            return `
            <div class="text-center py-4">
                <h5 class="text-muted">${config.title}</h5>
                <p class="text-muted">${config.text}</p>
            </div>
        `;
        }

        hideResults() {
            document.getElementById('resultsSection')?.classList.add('d-none');
            document.getElementById('noResults')?.classList.add('d-none');
        }

        showError(message) {
            const errorState = document.getElementById('errorState');
            const errorMessage = document.getElementById('errorMessage');

            if (errorState && errorMessage) {
                errorMessage.textContent = message;
                errorState.classList.remove('d-none');
            }

            this.hideResults();
        }

        hideError() {
            document.getElementById('errorState')?.classList.add('d-none');
        }

        showAlert(message, type = 'info') {
            const types = {
                'info': 'alert-info',
                'warning': 'alert-warning',
                'error': 'alert-danger',
                'success': 'alert-success'
            };

            const alert = document.createElement('div');
            alert.className = `alert ${types[type]} alert-dismissible fade show`;
            alert.innerHTML = `
            ${this.escapeHtml(message)}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;

            document.querySelector('.container').prepend(alert);

            setTimeout(() => alert.remove(), 5000);
        }

        async loadInitialStats() {
            try {
                const response = await fetch('/api/stats');
                const stats = await response.json();

                if (!stats.error) {
                    document.getElementById('totalMovies').textContent = stats.total_peliculas || 0;
                    document.getElementById('totalDirectors').textContent = stats.total_directores || 0;
                    document.getElementById('totalTriples').textContent = stats.total_triples || 0;
                }
            } catch (error) {
                console.error('Error cargando estadísticas:', error);
            }
        }

        escapeHtml(text) {
            if (typeof text !== 'string') return text;
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
    }

    // Inicializar aplicación
    document.addEventListener('DOMContentLoaded', () => {
        window.cinemaSearch = new CinemaSearch();
    });
</script>
{% endblock %}